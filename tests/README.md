# Test Suite for `dirdigest`

## Running the Tests

Running the tests is straightforward using the provided `Makefile`.

1.  **Ensure Development Dependencies are Installed:**
    Make sure you have set up the development environment and installed all dependencies, including `pytest`. If you followed the main project's [Development Setup](../README.md#development-setup) instructions (which uses `make setup`), these will already be installed in your virtual environment.
    ```bash
    # If you haven't already, from the project root:
    # make setup
    # source .venv/bin/activate
    ```

2.  **Run Tests using `make test` (Recommended):**
    From the root directory of the `dirdigest` project, simply run:
    ```bash
    make test
    ```
    This command will automatically:
    *   Execute the `tests/scripts/setup_test_dirs.sh` script to create mock directory fixtures.
    *   Run `pytest` on the `tests/` directory.
    *   Clean up the mock directory fixtures after the tests complete.

3.  **Running `pytest` Directly (Alternative):**
    If you need more granular control (e.g., running specific test files, using `pytest` flags like `-vv` for verbose output, or `-k` to select tests by keyword), you can run `pytest` directly.

    *   **First, manually set up the mock directory fixtures:**
        The test suite relies on pre-defined directory structures. A helper script is provided to create these:
        ```bash
        # From the root directory of the project
        bash tests/scripts/setup_test_dirs.sh
        ```
        It's recommended to run this script once before running `pytest` manually.

    *   **Then, run `pytest`:**
        Navigate to the root directory of the `dirdigest` project and run:
        ```bash
        pytest
        # or, using uv from the Makefile's venv:
        # uv run pytest tests/
        ```
        This will discover and run all tests within the `tests/` directory.

        To run a specific test file:
        ```bash
        pytest tests/test_cli_args.py
        pytest tests/test_traversal_filtering.py
        # etc.
        ```

        To run a specific test function or class:
        ```bash
        pytest tests/test_configuration.py::TestConfigLoadingAndMerging::test_load_default_config_file_name
        pytest tests/test_content_processing.py::TestMaxSizeHandling
        ```

        For more verbose output:
        ```bash
        pytest -vv
        ```
    *   **Remember to manually clean up fixtures if needed:**
        The mock directories are created in `tests/fixtures/test_dirs/`. The `make test` target handles cleanup. If running manually, you might want to remove this directory if it was created by the script:
        ```bash
        # rm -rf tests/fixtures/test_dirs
        ```
        (The `setup_test_dirs.sh` script itself creates `tests/fixtures/test_dirs` if it doesn't exist, so be mindful of what you're deleting if you have other persistent fixtures there.)

## Test Organization and Coverage

The tests are organized into several files, each focusing on a specific aspect of `dirdigest`:

*   **`tests/conftest.py`**:
    *   Contains shared `pytest` fixtures used across multiple test files.
    *   `runner`: Provides a `click.testing.CliRunner` instance to invoke CLI commands.
    *   `temp_test_dir`: Creates isolated temporary directories, populates them with mock file structures copied from the ones generated by `tests/scripts/setup_test_dirs.sh` (which are placed in `tests/fixtures/test_dirs/`), and manages CWD for tests. This is crucial for filesystem-dependent tests.
    *   `mock_pyperclip`: Mocks the `pyperclip` library for testing clipboard functionality.

*   **`tests/test_cli_args.py`**:
    *   **Focus**: Command-Line Interface (CLI) argument parsing and basic invocation.
    *   **Coverage**: Help messages, version output, basic successful invocation, invalid arguments, parsing of options, clipboard flags.

*   **`tests/test_traversal_filtering.py`**:
    *   **Focus**: Core file and directory traversal logic, and filtering mechanisms.
    *   **Coverage**: Basic traversal, default ignores, `--no-default-ignore`, hidden files, `--max-depth`, include/exclude patterns, symlink handling.

Welcome to the `dirdigest` test suite! This suite is designed to ensure the reliability, correctness, and robustness of the `dirdigest` command-line tool. We use `pytest` as our test runner and leverage various mock objects and fixtures to create isolated and repeatable test environments.

Our philosophy is to test thoroughly, from the command-line interface down to the core logic of file processing and output formatting. We believe that a strong test suite is the bedrock of a high-quality tool. (And also, it helps us sleep better at night, knowing the digital gremlins are kept at bay!)

*   **`tests/test_content_processing.py`**:
    *   **Focus**: How `dirdigest` handles file content after selection.
    *   **Coverage**: `--max-size`, empty files, file read errors (permission, Unicode) with/without `--ignore-errors`, UTF-8 handling.

*   **`tests/test_output_formatting.py`**:
    *   **Focus**: Validation of Markdown and JSON outputs.
    *   **Coverage (Markdown)**: Header, directory structure visualization, file content sections, language hints, error representation.
    *   **Coverage (JSON)**: Metadata fields, `root` node structure.

*   **`tests/test_configuration.py`**:
    *   **Focus**: Loading and merging settings from config files and CLI arguments.
    *   **Coverage**: Default/custom config files, CLI override precedence, YAML data types, config structures, malformed/missing files.

## Mock Fixtures (`tests/fixtures/test_dirs/`)

The test suite uses various pre-defined directory structures for testing. These structures are created by the `tests/scripts/setup_test_dirs.sh` script inside `tests/fixtures/test_dirs/`. The `make test` command runs this script automatically. If you run `pytest` directly, you should execute `bash tests/scripts/setup_test_dirs.sh` first.

These mock directories are designed to cover a wide range of scenarios:

*   `empty_dir/`: An empty directory.
*   `simple_project/`: A basic project with a few files and one subdirectory.
*   `complex_project/`: A more elaborate structure with nested directories, hidden files, default-ignored directories (like `.git`, `__pycache__`, `node_modules`), and various file types. Used to test default ignores, depth, and complex traversals.
*   `large_files_dir/`: Contains files of specific sizes to test `--max-size`.
*   `hidden_files_dir/`: Specifically for testing handling of hidden files and files within hidden directories.
*   `symlink_dir/`: Contains target files/directories and various symbolic links to test symlink handling logic.
*   `symlink_loop_dir/`: Contains a simple symlink loop.
*   `content_processing_dir/`: Contains files for testing content-related scenarios (sizes, UTF-8, binary, permissions).
*   `lang_hint_project/`: Contains files with various extensions to test language hinting in Markdown.
*   `all_ignored_dir/`: A directory where all contents should be ignored by default patterns.
*   `special_chars_dir/`: Contains files and directory names with spaces, special characters, and Unicode characters.

These fixtures are crucial for creating consistent and reproducible test conditions.
